<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Carte (autoload JSON, sans modifier l'original)</title>
  <style>
    html,body { height:100%; margin:0; }
    #stage { height:100%; }
  </style>
</head>
<body>
<script>
(async function(){
  // 1) Nom de votre fichier HTML ORIGINAL (inchangé)
  const ORIGINAL_HTML = "carte_entreprises_fonctionnelles_V5_autoload.html";
  // 2) Nom du JSON à charger automatiquement (même dossier)
  const JSON_PATH = "entreprises_export.json";

  // On télécharge le HTML original et on le "monte" tel quel dans ce document
  const res = await fetch(ORIGINAL_HTML, {cache:"no-store"});
  if(!res.ok){
    document.body.innerHTML = "<p style='font:16px sans-serif;padding:16px'>Impossible de charger le fichier HTML original ("+ORIGINAL_HTML+").</p>";
    return;
  }
  const htmlText = await res.text();
  document.open();
  document.write(htmlText);
  document.close();

  // Quand tout le HTML original est prêt, on déclenche l'auto-chargement du JSON
  window.addEventListener("load", async () => {
    try{
      const r = await fetch(JSON_PATH + "?t=" + Date.now(), {headers: {"Accept": "application/json"}});
      if(!r.ok) throw new Error("HTTP " + r.status);
      const data = await r.json();
      const arr = Array.isArray(data) ? data : (Array.isArray(data.data) ? data.data : null);
      if(!arr) throw new Error("Le JSON doit être un tableau d'objets.");

      // Sans toucher à l'original : on utilise ses fonctions s'elles existent
      window.RAW = arr;
      if(typeof computeFacets === "function") computeFacets(window.RAW);
      if(typeof rebuildFilters === "function") rebuildFilters();
      if(typeof addMarkers === "function") addMarkers(window.RAW);
      if(typeof applyFilters === "function") applyFilters(); // applique rayon/menus
      // L'import manuel du fichier reste disponible dans l'original.
    }catch(err){
      console.warn("[Wrapper] Échec autoload JSON:", err);
      // On n'affiche pas d'alerte bloquante : l'utilisateur peut importer manuellement.
    }
  });
})();
</script>
</body>
</html>
